name: Publish nodecore Helm Chart

on:
  pull_request:
    paths:
      - 'chart/nodecore/**'
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, tag or SHA to publish from (empty = current branch)"
        required: false
        type: string
        default: ""

env:
  HELM_VERSION: v3.8.0
  CHART_DIR: chart/nodecore
  CHART_NAME: nodecore
  CHART_REPOSITORY: nodecore-chart

permissions:
  contents: read
  packages: write

jobs:
  ct-lint:
    if: github.event_name == 'pull_request'
    name: Lint & check version bump
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Run chart-testing (lint + version increment)
        run: |
          ct lint \
            --chart-dirs chart \
            --charts ${{ env.CHART_DIR }} \
            --check-version-increment \
            --target-branch main

      - name: Helm lint chart
        shell: bash
        run: helm lint chart/nodecore --strict

      - name: Check chart version increment
        uses: ./.github/actions/check-chart-version
        with:
          chart-path: chart/nodecore

  publish-helm-chart-nodecore:
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || github.ref_name }}

      - name: Resolve parameters
        id: resolve_parameters
        run: |
          resolvedRef="${{ inputs.ref }}"
          if [ -z "$resolvedRef" ]; then
            resolvedRef="${{ github.ref }}"
          fi
          echo "resolved_ref=$resolvedRef" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short "$resolvedRef")" >> $GITHUB_OUTPUT

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install yq
        shell: bash
        run: |
          YQ_VERSION=v4.45.1
          sudo curl -L https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Login to GHCR
        run: |
          echo "${{ github.token }}" \
            | helm registry login ghcr.io \
                --username "${{ github.actor }}" \
                --password-stdin

      - name: Package & push nodecore chart
        run: |
          CHART_VERSION_TAG=$(yq e '.version' ${{ env.CHART_DIR }}/Chart.yaml)
          echo "CHART_VERSION_TAG=${CHART_VERSION_TAG}" >> $GITHUB_ENV
      
          helm package "${{ env.CHART_DIR }}" \
            --version="${CHART_VERSION_TAG}" \
            --app-version="${CHART_VERSION_TAG}"
      
          # file: nodecore-<version>.tgz
          helm push "${{ env.CHART_NAME }}-${CHART_VERSION_TAG}.tgz" \
            oci://ghcr.io/drpcorg/${{ env.CHART_REPOSITORY }}
